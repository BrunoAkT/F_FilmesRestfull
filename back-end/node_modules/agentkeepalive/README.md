# agentkeepalive

[![NPM version][npm-image]][npm-url]
[![Known Vulnerabilities][snyk-image]][snyk-url]
[![Node.js CI](https://github.com/node-modules/agentkeepalive/actions/workflows/nodejs.yml/badge.svg)](https://github.com/node-modules/agentkeepalive/actions/workflows/nodejs.yml)
[![npm download][download-image]][download-url]

[npm-image]: https://img.shields.io/npm/v/agentkeepalive.svg?style=flat
[npm-url]: https://npmjs.org/package/agentkeepalive
[snyk-image]: https://snyk.io/test/npm/agentkeepalive/badge.svg?style=flat-square
[snyk-url]: https://snyk.io/test/npm/agentkeepalive
[download-image]: https://img.shields.io/npm/dm/agentkeepalive.svg?style=flat-square
[download-url]: https://npmjs.org/package/agentkeepalive

The enhancement features `keep alive` `http.Agent`. Support `http` and `https`.

## What's different from original `http.Agent`?

- `keepAlive=true` by default
- Disable Nagle's algorithm: `socket.setNoDelay(true)`
- Add free socket timeout: avoid long time inactivity socket leak in the free-sockets queue.
- Add active socket timeout: avoid long time inactivity socket leak in the active-sockets queue.
- TTL for active socket.

## Node.js version required

Support Node.js >= `8.0.0`

## Install

```bash
$ npm install agentkeepalive --save
```

## new Agent([options])

* `options` {Object} Set of configurable options to set on the agent.
  Can have the following fields:
  * `keepAlive` {Boolean} Keep sockets around in a pool to be used by
    other requests in the future. Default = `true`.
  * `keepAliveMsecs` {Number} When using the keepAlive option, specifies the initial delay
    for TCP Keep-Alive packets. Ignored when the keepAlive option is false or undefined. Defaults to 1000.
    Default = `1000`.  Only relevant if `keepAlive` is set to `true`.
  * `freeSocketTimeout`: {Number} Sets the free socket to timeout
    after `freeSocketTimeout` milliseconds of inactivity on the free socket.
    The default [server-side timeout](https://nodejs.org/api/http.html#serverkeepalivetimeout) is 5000 milliseconds, to [avoid ECONNRESET exceptions](https://medium.com/ssense-tech/reduce-networking-errors-in-nodejs-23b4eb9f2d83), we set the default value to `4000` milliseconds.
    Only relevant if `keepAlive` is set to `true`.
  * `timeout`: {Number} Sets the working socket to timeout
    after `timeout` milliseconds of inactivity on the working socket.
    Default is `freeSocketTimeout * 2` so long as that value is greater than or equal to 8 seconds, otherwise the default is 8 seconds.
  * `maxSockets` {Number} Maximum number of sockets to allow per
    host. Default = `Infinity`.
  * `maxFreeSockets` {Number} Maximum number of sockets (per host) to leave open
    in a free state. Only relevant if `keepAlive` is set to `true`.
    Default = `256`.
  * `socketActiveTTL` {Number} Sets the socket active time to live, even if it's in use.
    If not set, the behaviour keeps the same (the socket will be released only when free)
    Default = `null`.

## Usage

```js
const http = require('http');
const HttpAgent = require('agentkeepalive').HttpAgent;

const keepaliveAgent = new HttpAgent({
  maxSockets: 100,
  maxFreeSockets: 10,
  timeout: 60000, // active socket keepalive for 60 seconds
  freeSocketTimeout: 30000, // free socket keepalive for 30 seconds
});

const options = {
  host: 'cnodejs.org',
  port: 80,
  path: '/',
  method: 'GET',
  agent: keepaliveAgent,
};

const req = http.request(options, res => {
  console.log('STATUS: ' + res.statusCode);
  console.log('HEADERS: ' + JSON.stringify(res.headers));
  res.setEncoding('utf8');
  res.on('data', function (chunk) {
    console.log('BODY: ' + chunk);
  });
});
req.on('error', e => {
  console.log('problem with request: ' + e.message);
});
req.end();

setTimeout(() => {
  if (keepaliveAgent.statusChanged) {
    console.log('[%s] agent status changed: %j', Date(), keepaliveAgent.getCurrentStatus());
  }
}, 2000);

```

### `getter agent.statusChanged`

counters have change or not after last checkpoint.

### `agent.getCurrentStatus()`

`agent.getCurrentStatus()` {"net":{"http_server_properties":{"servers":[{"anonymization":[],"server":"https://vscodeexperiments.azureedge.net","supports_spdy":true},{"anonymization":[],"server":"https://riki-larson.gallerycdn.vsassets.io","supports_spdy":true},{"anonymization":[],"server":"https://zhihaocui.gallerycdn.vsassets.io","supports_spdy":true},{"anonymization":[],"server":"https://vladimirsharavanov.gallerycdn.vsassets.io","supports_spdy":true},{"anonymization":[],"server":"https://shiyangzhaoa.gallerycdn.vsassets.io","supports_spdy":true},{"anonymization":[],"server":"https://eamodio.gallerycdn.vsassets.io","supports_spdy":true},{"anonymization":[],"server":"https://avatars2.githubusercontent.com","supports_spdy":true},{"anonymization":[],"server":"https://external-content.duckduckgo.com","supports_spdy":true},{"anonymization":[],"server":"https://www.microsoft.com","supports_spdy":true},{"anonymization":[],"network_stats":{"srtt":124587},"server":"https://rawcdn.githack.com","supports_spdy":true},{"anonymization":[],"network_stats":{"srtt":15636},"server":"https://img.shields.io","supports_spdy":true},{"anonymization":[],"server":"https://heartacker.gallerycdn.vsassets.io","supports_spdy":true},{"anonymization":[],"server":"https://mobile.events.data.microsoft.com","supports_spdy":true},{"anonymization":[],"server":"https://az764295.vo.msecnd.net","supports_spdy":true},{"anonymization":[],"server":"https://ritwickdey.gallery.vsassets.io","supports_spdy":true},{"anonymization":[],"server":"https://equinusocio.gallery.vsassets.io","supports_spdy":true},{"anonymization":[],"server":"https://dev.azure.com","supports_spdy":true},{"anonymization":[],"server":"https://counterscale.sqliteviewer.app","supports_spdy":true},{"anonymization":[],"server":"https://vscode.sqliteviewer.app","supports_spdy":true},{"anonymization":[],"server":"https://ms-vscode.gallery.vsassets.io","supports_spdy":true},{"anonymization":[],"server":"https://user-images.githubusercontent.com","supports_spdy":true},{"anonymization":[],"server":"https://dbaeumer.gallery.vsassets.io","supports_spdy":true},{"anonymization":[],"server":"https://ms-python.gallery.vsassets.io","supports_spdy":true},{"anonymization":[],"server":"https://dracula-theme.gallery.vsassets.io","supports_spdy":true},{"anonymization":[],"server":"https://raw.githubusercontent.com","supports_spdy":true},{"anonymization":[],"server":"https://github.com","supports_spdy":true},{"anonymization":[],"server":"https://ms-vsliveshare.gallery.vsassets.io","supports_spdy":true},{"anonymization":[],"server":"https://ms-toolsai.gallery.vsassets.io","supports_spdy":true},{"anonymization":[],"server":"https://github.gallery.vsassets.io","supports_spdy":true},{"anonymization":[],"server":"https://github.gallerycdn.vsassets.io","supports_spdy":true},{"anonymization":[],"server":"https://ms-vscode.gallerycdn.vsassets.io","supports_spdy":true},{"anonymization":[],"server":"https://ms-toolsai.gallerycdn.vsassets.io","supports_spdy":true},{"anonymization":[],"server":"https://ritwickdey.gallerycdn.vsassets.io","supports_spdy":true},{"anonymization":[],"server":"https://ms-vsliveshare.gallerycdn.vsassets.io","supports_spdy":true},{"anonymization":[],"server":"https://ms-python.gallerycdn.vsassets.io","supports_spdy":true},{"anonymization":[],"server":"https://dracula-theme.gallerycdn.vsassets.io","supports_spdy":true},{"anonymization":[],"server":"https://ms-edgedevtools.gallerycdn.vsassets.io","supports_spdy":true},{"anonymization":[],"server":"https://ms-ceintl.gallery.vsassets.io","supports_spdy":true},{"anonymization":[],"server":"https://secure.gravatar.com","supports_spdy":true},{"anonymization":[],"server":"https://ms-ceintl.gallerycdn.vsassets.io","supports_spdy":true},{"anonymization":[],"server":"https://code.visualstudio.com","supports_spdy":true},{"anonymization":[],"server":"https://vscode.download.prss.microsoft.com","supports_spdy":true},{"anonymization":[],"server":"https://www.vscode-unpkg.net","supports_spdy":true},{"anonymization":[],"server":"https://default.exp-tas.com","supports_spdy":true},{"anonymization":[],"server":"https://update.code.visualstudio.com","supports_spdy":true},{"anonymization":[],"server":"https://marketplace.visualstudio.com","supports_spdy":true},{"anonymization":[],"server":"https://api.github.com","supports_spdy":true},{"anonymization":[],"server":"https://cdn.jsdelivr.net","supports_spdy":true},{"anonymization":[],"server":"https://avatars.githubusercontent.com","supports_spdy":true},{"anonymization":[],"server":"https://main.vscode-cdn.net","supports_spdy":true}],"supports_quic":{"address":"192.168.1.101","used_quic":true},"version":5},"network_qualities":{"CAASABiAgICA+P////8B":"4G","CAESABiAgICA+P////8B":"4G","CAISABiAgICA+P////8B":"4G","CAYSABiAgICA+P////8B":"Offline"}}}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 